//! This code was AUTOGENERATED using the Codama library.
pub mod close_vault_row;
pub mod create_vault_authority_row;
pub mod drain_vault_row;

pub use self::close_vault_row::*;
pub use self::create_vault_authority_row::*;
pub use self::drain_vault_row::*;

use super::ProfileVaultInstruction;

pub struct ProfileVaultInstructionsMigration;

impl sqlx_migrator::Migration<sqlx::Postgres> for ProfileVaultInstructionsMigration {
    fn app(&self) -> &str {
        "profile-vault"
    }

    fn name(&self) -> &str {
        "profile_vault_instructions"
    }

    fn operations(&self) -> Vec<Box<dyn sqlx_migrator::Operation<sqlx::Postgres>>> {
        vec![
            Box::new(CloseVaultMigrationOperation),
            Box::new(CreateVaultAuthorityMigrationOperation),
            Box::new(DrainVaultMigrationOperation),
        ]
    }

    fn parents(&self) -> Vec<Box<dyn sqlx_migrator::Migration<sqlx::Postgres>>> {
        vec![]
    }
}

pub struct ProfileVaultInstructionWithMetadata(
    pub ProfileVaultInstruction,
    pub carbon_core::instruction::InstructionMetadata,
);

impl
    From<(
        ProfileVaultInstruction,
        carbon_core::instruction::InstructionMetadata,
    )> for ProfileVaultInstructionWithMetadata
{
    fn from(
        value: (
            ProfileVaultInstruction,
            carbon_core::instruction::InstructionMetadata,
        ),
    ) -> Self {
        ProfileVaultInstructionWithMetadata(value.0, value.1)
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Insert for ProfileVaultInstructionWithMetadata {
    async fn insert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let ProfileVaultInstructionWithMetadata(instruction, metadata) = self;
        match instruction {
            ProfileVaultInstruction::CloseVault(instruction) => {
                let row = close_vault_row::CloseVaultRow::from_parts(
                    instruction.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
            ProfileVaultInstruction::CreateVaultAuthority(instruction) => {
                let row = create_vault_authority_row::CreateVaultAuthorityRow::from_parts(
                    instruction.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
            ProfileVaultInstruction::DrainVault(instruction) => {
                let row = drain_vault_row::DrainVaultRow::from_parts(
                    instruction.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
        }
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Upsert for ProfileVaultInstructionWithMetadata {
    async fn upsert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let ProfileVaultInstructionWithMetadata(instruction, metadata) = self;
        match instruction {
            ProfileVaultInstruction::CloseVault(instruction) => {
                let row = close_vault_row::CloseVaultRow::from_parts(
                    instruction.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
            ProfileVaultInstruction::CreateVaultAuthority(instruction) => {
                let row = create_vault_authority_row::CreateVaultAuthorityRow::from_parts(
                    instruction.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
            ProfileVaultInstruction::DrainVault(instruction) => {
                let row = drain_vault_row::DrainVaultRow::from_parts(
                    instruction.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
        }
    }
}
