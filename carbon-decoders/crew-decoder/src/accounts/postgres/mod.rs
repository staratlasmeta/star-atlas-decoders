//! This code was AUTOGENERATED using the Codama library.
pub mod crew_config_row;
pub mod pack_tiers_row;
pub mod pack_type_row;
pub mod sft_redemption_row;
pub mod user_redemption_row;

pub use self::crew_config_row::*;
pub use self::pack_tiers_row::*;
pub use self::pack_type_row::*;
pub use self::sft_redemption_row::*;
pub use self::user_redemption_row::*;

use super::CrewAccount;

pub struct CrewAccountsMigration;

impl sqlx_migrator::Migration<sqlx::Postgres> for CrewAccountsMigration {
    fn app(&self) -> &str {
        "crew"
    }

    fn name(&self) -> &str {
        "crew_accounts"
    }

    fn operations(&self) -> Vec<Box<dyn sqlx_migrator::Operation<sqlx::Postgres>>> {
        vec![
            Box::new(CrewConfigMigrationOperation),
            Box::new(PackTiersMigrationOperation),
            Box::new(PackTypeMigrationOperation),
            Box::new(SftRedemptionMigrationOperation),
            Box::new(UserRedemptionMigrationOperation),
        ]
    }

    fn parents(&self) -> Vec<Box<dyn sqlx_migrator::Migration<sqlx::Postgres>>> {
        vec![]
    }
}

pub struct CrewAccountWithMetadata(pub CrewAccount, pub carbon_core::account::AccountMetadata);

impl From<(CrewAccount, carbon_core::account::AccountMetadata)> for CrewAccountWithMetadata {
    fn from(value: (CrewAccount, carbon_core::account::AccountMetadata)) -> Self {
        CrewAccountWithMetadata(value.0, value.1)
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Insert for CrewAccountWithMetadata {
    async fn insert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let CrewAccountWithMetadata(account, metadata) = self;

        match account {
            CrewAccount::CrewConfig(account) => {
                let row =
                    crew_config_row::CrewConfigRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            CrewAccount::PackTiers(account) => {
                let row =
                    pack_tiers_row::PackTiersRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            CrewAccount::PackType(account) => {
                let row =
                    pack_type_row::PackTypeRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            CrewAccount::SftRedemption(account) => {
                let row = sft_redemption_row::SftRedemptionRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
            CrewAccount::UserRedemption(account) => {
                let row = user_redemption_row::UserRedemptionRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
        }
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Upsert for CrewAccountWithMetadata {
    async fn upsert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let CrewAccountWithMetadata(account, metadata) = self;
        match account {
            CrewAccount::CrewConfig(account) => {
                let row =
                    crew_config_row::CrewConfigRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            CrewAccount::PackTiers(account) => {
                let row =
                    pack_tiers_row::PackTiersRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            CrewAccount::PackType(account) => {
                let row =
                    pack_type_row::PackTypeRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            CrewAccount::SftRedemption(account) => {
                let row = sft_redemption_row::SftRedemptionRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
            CrewAccount::UserRedemption(account) => {
                let row = user_redemption_row::UserRedemptionRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
        }
    }
}
