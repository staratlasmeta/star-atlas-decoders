//! This code was AUTOGENERATED using the Codama library.
pub mod player_name_row;
pub mod profile_role_membership_row;
pub mod profile_row;
pub mod role_row;

pub use self::player_name_row::*;
pub use self::profile_role_membership_row::*;
pub use self::profile_row::*;
pub use self::role_row::*;

use super::PlayerProfileAccount;

pub struct PlayerProfileAccountsMigration;

impl sqlx_migrator::Migration<sqlx::Postgres> for PlayerProfileAccountsMigration {
    fn app(&self) -> &str {
        "player-profile"
    }

    fn name(&self) -> &str {
        "player_profile_accounts"
    }

    fn operations(&self) -> Vec<Box<dyn sqlx_migrator::Operation<sqlx::Postgres>>> {
        vec![
            Box::new(PlayerNameMigrationOperation),
            Box::new(ProfileMigrationOperation),
            Box::new(ProfileRoleMembershipMigrationOperation),
            Box::new(RoleMigrationOperation),
        ]
    }

    fn parents(&self) -> Vec<Box<dyn sqlx_migrator::Migration<sqlx::Postgres>>> {
        vec![]
    }
}

pub struct PlayerProfileAccountWithMetadata(
    pub PlayerProfileAccount,
    pub carbon_core::account::AccountMetadata,
);

impl From<(PlayerProfileAccount, carbon_core::account::AccountMetadata)>
    for PlayerProfileAccountWithMetadata
{
    fn from(value: (PlayerProfileAccount, carbon_core::account::AccountMetadata)) -> Self {
        PlayerProfileAccountWithMetadata(value.0, value.1)
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Insert for PlayerProfileAccountWithMetadata {
    async fn insert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let PlayerProfileAccountWithMetadata(account, metadata) = self;

        match account {
            PlayerProfileAccount::PlayerName(account) => {
                let row =
                    player_name_row::PlayerNameRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            PlayerProfileAccount::Profile(account) => {
                let row = profile_row::ProfileRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
            PlayerProfileAccount::ProfileRoleMembership(account) => {
                let row = profile_role_membership_row::ProfileRoleMembershipRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
            PlayerProfileAccount::Role(account) => {
                let row = role_row::RoleRow::from_parts(*account.clone(), metadata.clone());
                row.insert(pool).await?;
                Ok(())
            }
        }
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Upsert for PlayerProfileAccountWithMetadata {
    async fn upsert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let PlayerProfileAccountWithMetadata(account, metadata) = self;
        match account {
            PlayerProfileAccount::PlayerName(account) => {
                let row =
                    player_name_row::PlayerNameRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            PlayerProfileAccount::Profile(account) => {
                let row = profile_row::ProfileRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
            PlayerProfileAccount::ProfileRoleMembership(account) => {
                let row = profile_role_membership_row::ProfileRoleMembershipRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
            PlayerProfileAccount::Role(account) => {
                let row = role_row::RoleRow::from_parts(*account.clone(), metadata.clone());
                row.upsert(pool).await?;
                Ok(())
            }
        }
    }
}
