//! This code was AUTOGENERATED using the Codama library.
pub mod registered_stake_row;
pub mod staking_account_row;
pub mod staking_vars_row;

pub use self::registered_stake_row::*;
pub use self::staking_account_row::*;
pub use self::staking_vars_row::*;

use super::AtlasStakingAccount;

pub struct AtlasStakingAccountsMigration;

impl sqlx_migrator::Migration<sqlx::Postgres> for AtlasStakingAccountsMigration {
    fn app(&self) -> &str {
        "atlas-staking"
    }

    fn name(&self) -> &str {
        "atlas_staking_accounts"
    }

    fn operations(&self) -> Vec<Box<dyn sqlx_migrator::Operation<sqlx::Postgres>>> {
        vec![
            Box::new(RegisteredStakeMigrationOperation),
            Box::new(StakingAccountMigrationOperation),
            Box::new(StakingVarsMigrationOperation),
        ]
    }

    fn parents(&self) -> Vec<Box<dyn sqlx_migrator::Migration<sqlx::Postgres>>> {
        vec![]
    }
}

pub struct AtlasStakingAccountWithMetadata(
    pub AtlasStakingAccount,
    pub carbon_core::account::AccountMetadata,
);

impl From<(AtlasStakingAccount, carbon_core::account::AccountMetadata)>
    for AtlasStakingAccountWithMetadata
{
    fn from(value: (AtlasStakingAccount, carbon_core::account::AccountMetadata)) -> Self {
        AtlasStakingAccountWithMetadata(value.0, value.1)
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Insert for AtlasStakingAccountWithMetadata {
    async fn insert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let AtlasStakingAccountWithMetadata(account, metadata) = self;

        match account {
            AtlasStakingAccount::RegisteredStake(account) => {
                let row = registered_stake_row::RegisteredStakeRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
            AtlasStakingAccount::StakingAccount(account) => {
                let row = staking_account_row::StakingAccountRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
            AtlasStakingAccount::StakingVars(account) => {
                let row = staking_vars_row::StakingVarsRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.insert(pool).await?;
                Ok(())
            }
        }
    }
}

#[async_trait::async_trait]
impl carbon_core::postgres::operations::Upsert for AtlasStakingAccountWithMetadata {
    async fn upsert(&self, pool: &sqlx::PgPool) -> carbon_core::error::CarbonResult<()> {
        let AtlasStakingAccountWithMetadata(account, metadata) = self;
        match account {
            AtlasStakingAccount::RegisteredStake(account) => {
                let row = registered_stake_row::RegisteredStakeRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
            AtlasStakingAccount::StakingAccount(account) => {
                let row = staking_account_row::StakingAccountRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
            AtlasStakingAccount::StakingVars(account) => {
                let row = staking_vars_row::StakingVarsRow::from_parts(
                    *account.clone(),
                    metadata.clone(),
                );
                row.upsert(pool).await?;
                Ok(())
            }
        }
    }
}
