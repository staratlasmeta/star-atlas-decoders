//! This code was AUTOGENERATED using the Codama library.
use carbon_core::borsh::{self, BorshDeserialize};
use solana_pubkey::Pubkey;

use crate::types::LocationType;

/// Represents a crafting facility account

#[cfg_attr(feature = "serde", derive(serde::Serialize, serde::Deserialize))]
#[derive(Debug, Clone, PartialEq)]
pub struct CraftingFacility {
    /// The data version of this account.
    pub version: u8,
    /// the domain
    pub domain: Pubkey,
    /// the location's pubkey
    pub location: Pubkey,
    /// the location type
    pub location_type: LocationType,
    /// the max. number of concurrent crafting processes that can be handled by this facility
    /// if 0 then there is no max
    pub max_concurrent_processes: u32,
    /// the current number of concurrent crafting processes
    pub num_concurrent_processes: u32,
    /// the efficiency rate for this crafting_facility (as basis points)
    pub efficiency: u32,
    /// number of recipe categories
    pub num_recipe_categories: u32,
    /// RemainingData: UnorderedList<WrappedRecipeCategory>
    pub recipe_categories: Vec<Pubkey>,
}

impl borsh::de::BorshDeserialize for CraftingFacility
where
    u8: borsh::BorshDeserialize,
    Pubkey: borsh::BorshDeserialize,
    LocationType: borsh::BorshDeserialize,
    u32: borsh::BorshDeserialize,
{
    fn deserialize_reader<R: borsh::io::Read>(reader: &mut R) -> Result<Self, borsh::io::Error> {
        Ok(Self {
            version: borsh::BorshDeserialize::deserialize_reader(reader)?,
            domain: borsh::BorshDeserialize::deserialize_reader(reader)?,
            location: borsh::BorshDeserialize::deserialize_reader(reader)?,
            location_type: borsh::BorshDeserialize::deserialize_reader(reader)?,
            max_concurrent_processes: borsh::BorshDeserialize::deserialize_reader(reader)?,
            num_concurrent_processes: borsh::BorshDeserialize::deserialize_reader(reader)?,
            efficiency: borsh::BorshDeserialize::deserialize_reader(reader)?,
            num_recipe_categories: borsh::BorshDeserialize::deserialize_reader(reader)?,
            recipe_categories: Vec::new(), // Will be populated by CarbonDeserialize
        })
    }
}

impl carbon_core::deserialize::CarbonDeserialize for CraftingFacility {
    const DISCRIMINATOR: &'static [u8] = &[58u8, 73u8, 35u8, 17u8, 92u8, 247u8, 49u8, 30u8];

    fn deserialize(data: &[u8]) -> Option<Self> {
        // CraftingFacility has RemainingData = UnorderedList<WrappedRecipeCategory>
        // Contains a list of recipe category pubkeys (no length prefix in account)
        // Byte layout: version(1) + domain(32) + location(32) + location_type(1) + max_concurrent_processes(4) + num_concurrent_processes(4) + efficiency(4) + num_recipe_categories(4) = 82 bytes
        // All remaining bytes after fixed fields are Pubkeys (32 bytes each)

        let mut rest = data;

        let mut crafting_facility: CraftingFacility = match BorshDeserialize::deserialize(&mut rest)
        {
            Ok(res) => res,
            Err(_) => return None,
        };

        // Read num_recipe_categories pubkeys from remaining data
        let num_categories = crafting_facility.num_recipe_categories as usize;
        let mut recipe_categories = Vec::with_capacity(num_categories);

        for _ in 0..num_categories {
            let pubkey: Pubkey = match BorshDeserialize::deserialize(&mut rest) {
                Ok(p) => p,
                Err(_) => return None,
            };
            recipe_categories.push(pubkey);
        }

        crafting_facility.recipe_categories = recipe_categories;

        Some(crafting_facility)
    }
}

impl CraftingFacility {
    pub fn decode(data: &[u8]) -> Option<Self> {
        use carbon_core::deserialize::CarbonDeserialize;

        if data.len() < 8 {
            return None;
        }
        let discriminator = &data[0..8];
        if discriminator != Self::DISCRIMINATOR {
            return None;
        }

        let data_slice = &data[8..];
        <CraftingFacility as CarbonDeserialize>::deserialize(data_slice)
    }
}
